services:
  # Backend serves both API and frontend static files (single service)
  - type: web
    name: iot-backend
    runtime: node
    plan: starter
    # Build frontend; install backend deps (run backend via tsx at start)
    buildCommand: |
      cd frontend && npm install --legacy-peer-deps && npm run build && \
      cd ../backend && npm install --legacy-peer-deps
    startCommand: cd backend && npx tsx server.ts
    envVars:
      - key: NODE_ENV
        value: production
       # Frontend API Configuration
       - key: NEXT_PUBLIC_API_URL
         value: https://project004-backend2.onrender.com
      # Database & Auth
      - key: DYNAMODB_USERS_TABLE
        value: Users
      - key: DYNAMODB_DEVICE_STATUS_TABLE
        value: DeviceStatus
      - key: DYNAMODB_SENSOR_DATA_TABLE
        value: SensorData
      - key: DYNAMODB_NOTIFICATION_LOGS_TABLE
        value: NotificationLogs
      - key: AWS_REGION
        value: ap-southeast-1
      # AWS IoT Core (used by backend to publish control messages)
      - key: AWS_IOT_ENDPOINT
        value: a2zdea8txl0m71-ats.iot.ap-southeast-1.amazonaws.com
      - key: AWS_IOT_REGION
        value: ap-southeast-1
      - key: AWS_IOT_THING_NAME
        value: esp32-relay-01
      # JWT Secrets (set in Render dashboard)
      - key: JWT_SECRET
        sync: false
      - key: JWT_REFRESH_SECRET
        sync: false
      # AWS credentials (set in Render dashboard)
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      # CORS - same origin since frontend and backend are served together
      - key: FRONTEND_ORIGIN
        value: https://project004-backend2.onrender.com
      # Email (optional)
      - key: EMAIL_HOST
        value: smtp.gmail.com
      - key: EMAIL_PORT
        value: "587"
